!pip install streamlit pyngrok pandas numpy plotly


import io
import json
import base64
from datetime import datetime

import numpy as np
import pandas as pd
import plotly.express as px
import gradio as gr

# ---------------------------
# Utilities & risk model (same logic as your Streamlit code)
# ---------------------------
def sigmoid(x):
    return 1 / (1 + np.exp(-x))

def compute_bmi(height_cm: float, weight_kg: float) -> float:
    try:
        if height_cm is None or weight_kg is None or float(height_cm) <= 0:
            return np.nan
        return float(weight_kg) / ((float(height_cm) / 100) ** 2)
    except Exception:
        return np.nan

def normalize(x, mean, std, lo=None, hi=None):
    if x is None or pd.isna(x):
        return 0.0
    z = (float(x) - mean) / (std if std > 0 else 1.0)
    z = float(np.clip(z, -3, 3))
    if lo is not None and hi is not None:
        return float(np.clip(z, lo, hi))
    return z

def risk_model(features: dict):
    age = features.get("age", 35)
    bmi = features.get("bmi", np.nan)
    sys_bp = features.get("systolic_bp", 120)
    dia_bp = features.get("diastolic_bp", 80)
    fbg = features.get("fasting_glucose", 95)
    hba1c = features.get("hba1c", 5.3)
    chol = features.get("total_chol", 180)
    hdl = features.get("hdl", 50)
    ldl = features.get("ldl", 110)
    smoker = 1.0 if features.get("smoker", False) else 0.0
    fam = 1.0 if features.get("family_history", False) else 0.0
    act = features.get("activity_minutes_per_week", 60)

    n_age = normalize(age, 45, 12)
    n_bmi = normalize(bmi, 26, 5)
    n_sys = normalize(sys_bp, 125, 15)
    n_dia = normalize(dia_bp, 80, 10)
    n_fbg = normalize(fbg, 95, 12)
    n_a1c = normalize(hba1c, 5.4, 0.5)
    n_chol = normalize(chol, 190, 35)
    n_hdl = -normalize(hdl, 55, 12)
    n_ldl = normalize(ldl, 120, 30)
    n_act = -normalize(act, 120, 60)

    d_score = (
        0.9 * n_bmi
        + 1.2 * n_fbg
        + 1.2 * n_a1c
        + 0.5 * n_age
        + 0.5 * n_act
        + 0.6 * fam
        + 0.3 * smoker
        - 0.2
    )
    diabetes = float(sigmoid(d_score))

    h_score = (
        0.8 * n_age
        + 0.8 * n_chol
        + 0.7 * n_ldl
        + 0.6 * n_sys
        + 0.3 * n_dia
        + 0.8 * smoker
        + 0.6 * fam
        + 0.5 * n_bmi
        + 0.5 * n_act
        - 0.3
        + 0.8 * n_hdl
    )
    heart = float(sigmoid(h_score))

    ht_score = (
        1.2 * n_sys
        + 0.8 * n_dia
        + 0.6 * n_bmi
        + 0.6 * n_age
        + 0.4 * smoker
        + 0.5 * fam
        + 0.4 * n_act
        - 0.2
    )
    htn = float(sigmoid(ht_score))

    return {
        "diabetes_risk": round(diabetes, 3),
        "heart_disease_risk": round(heart, 3),
        "hypertension_risk": round(htn, 3),
    }

def risk_band(p):
    if p >= 0.67:
        return "High"
    if p >= 0.34:
        return "Moderate"
    return "Low"

def make_care_plan(features, risks):
    bmi = features.get("bmi", np.nan)
    act = features.get("activity_minutes_per_week", 0)
    sys_bp = features.get("systolic_bp", 120)
    fbg = features.get("fasting_glucose", 95)
    hba1c = features.get("hba1c", 5.3)
    smoker = features.get("smoker", False)

    d_band = risk_band(risks["diabetes_risk"])
    h_band = risk_band(risks["heart_disease_risk"])
    t_band = risk_band(risks["hypertension_risk"])

    plan = []
    plan.append("⚠ This autogenerated plan is not medical advice. Consult a clinician.")

    if pd.notna(bmi):
        if bmi >= 30:
            plan.append("• Weight management: target 5–10% weight loss over 6–12 months.")
        elif bmi >= 25:
            plan.append("• Aim to reach BMI < 25 with gradual lifestyle changes.")
        else:
            plan.append("• Maintain current healthy weight with balanced nutrition.")

    if act < 150:
        plan.append("• Physical activity: build to ≥150 min/week moderate activity (+ 2 strength days).")
    else:
        plan.append("• Keep ≥150 min/week activity; add flexibility/strength work 2–3×/week.")

    if smoker:
        plan.append("• Smoking: begin a cessation plan (set quit date, NRT or meds per clinician).")

    if d_band in ["Moderate", "High"] or fbg >= 100 or hba1c >= 5.7:
        plan.append("• Glucose management: reduce refined carbs/sugary drinks; prefer high-fiber foods.")
        plan.append("• Monitor fasting glucose weekly; discuss HbA1c testing cadence (e.g., q3–6 months).")

    if t_band in ["Moderate", "High"] or sys_bp >= 130:
        plan.append("• BP: limit sodium (~1.5–2 g/day), follow DASH-style diet, regular home BP logs.")
        plan.append("• Sleep hygiene: 7–9 h/night; screen for sleep apnea if snoring/daytime fatigue.")

    if h_band in ["Moderate", "High"]:
        plan.append("• Lipids/heart: prioritize unsaturated fats, fish 2×/week, soluble fiber.")
        plan.append("• Add stress management: daily 10-min breathing/meditation; social support.")

    plan.append("• Schedule preventive care visit; share home logs (BP/weight/glucose) with clinician.")
    return "\n".join(plan)

def to_download_bytes(dataframe):
    buf = io.StringIO()
    dataframe.to_csv(buf, index=False)
    return buf.getvalue().encode()

# ---------------------------
# Gradio app functions
# ---------------------------
def predict_single(
    age, sex, height_cm, weight_kg, systolic_bp, diastolic_bp,
    fasting_glucose, hba1c, total_chol, hdl, ldl,
    smoker, family_history, activity_minutes_per_week
):
    bmi = compute_bmi(height_cm, weight_kg)
    inputs = {
        "age": age,
        "sex": sex,
        "height_cm": height_cm,
        "weight_kg": weight_kg,
        "bmi": bmi,
        "systolic_bp": systolic_bp,
        "diastolic_bp": diastolic_bp,
        "fasting_glucose": fasting_glucose,
        "hba1c": hba1c,
        "total_chol": total_chol,
        "hdl": hdl,
        "ldl": ldl,
        "smoker": smoker,
        "family_history": family_history,
        "activity_minutes_per_week": activity_minutes_per_week,
    }
    risks = risk_model(inputs)
    plan = make_care_plan(inputs, risks)

    # build display dataframe
    df = pd.DataFrame({
        "Condition": ["Diabetes", "Heart Disease", "Hypertension"],
        "Risk": [risks["diabetes_risk"], risks["heart_disease_risk"], risks["hypertension_risk"]],
        "Band": [risk_band(risks["diabetes_risk"]), risk_band(risks["heart_disease_risk"]), risk_band(risks["hypertension_risk"])]
    })

    # bar figure
    fig = px.bar(df, x="Condition", y="Risk", color="Band", range_y=[0,1], text=df["Risk"].map(lambda x: f"{x:.2f}"))
    fig.update_layout(yaxis_title="Risk (0–1)", xaxis_title="")

    # create report bytes for download
    report = {
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "inputs": inputs,
        "risks": risks,
        "plan": plan,
    }
    txt = (
        "Healthcare Assistant Report (Demo)\n"
        "=================================\n\n"
        f"Timestamp (UTC): {report['timestamp']}\n\n"
        "Inputs:\n"
        + json.dumps(report["inputs"], indent=2)
        + "\n\nRisks:\n"
        + json.dumps(report["risks"], indent=2)
        + "\n\nPlan:\n"
        + report["plan"]
        + "\n"
    ).encode()

    return fig, df, plan, txt

def dashboard_from_csv(file_obj):
    # read csv into dataframe
    df = pd.read_csv(file_obj)
    sample_cols = [
        "patient_id","age","sex","height_cm","weight_kg","systolic_bp","diastolic_bp",
        "fasting_glucose","hba1c","total_chol","hdl","ldl","smoker","family_history","activity_minutes_per_week"
    ]
    for col in sample_cols:
        if col not in df.columns:
            df[col] = np.nan

    df["bmi"] = df.apply(lambda r: compute_bmi(r.get("height_cm", np.nan), r.get("weight_kg", np.nan)), axis=1)

    for bcol in ["smoker", "family_history"]:
        if bcol in df.columns:
            df[bcol] = df[bcol].map(lambda x: 1 if str(x).strip().lower() in ["1","true","yes","y"] else 0)

    def row_risks(r):
        feats = {
            "age": r.get("age", np.nan),
            "sex": r.get("sex", "Other"),
            "height_cm": r.get("height_cm", np.nan),
            "weight_kg": r.get("weight_kg", np.nan),
            "bmi": r.get("bmi", np.nan),
            "systolic_bp": r.get("systolic_bp", np.nan),
            "diastolic_bp": r.get("diastolic_bp", np.nan),
            "fasting_glucose": r.get("fasting_glucose", np.nan),
            "hba1c": r.get("hba1c", np.nan),
            "total_chol": r.get("total_chol", np.nan),
            "hdl": r.get("hdl", np.nan),
            "ldl": r.get("ldl", np.nan),
            "smoker": bool(r.get("smoker", 0)),
            "family_history": bool(r.get("family_history", 0)),
            "activity_minutes_per_week": r.get("activity_minutes_per_week", np.nan),
        }
        return risk_model(feats)

    risks_list = df.apply(row_risks, axis=1)
    df["diabetes_risk"] = risks_list.map(lambda d: d["diabetes_risk"])
    df["heart_disease_risk"] = risks_list.map(lambda d: d["heart_disease_risk"])
    df["hypertension_risk"] = risks_list.map(lambda d: d["hypertension_risk"])

    df["diabetes_band"] = df["diabetes_risk"].map(risk_band)
    df["heart_band"] = df["heart_disease_risk"].map(risk_band)
    df["hypertension_band"] = df["hypertension_risk"].map(risk_band)

    # Overview metrics
    metrics = {
        "patients": len(df),
        "avg_bmi": float(df["bmi"].mean()) if len(df) else float("nan"),
        "avg_systolic": float(df["systolic_bp"].mean()) if len(df) else float("nan"),
        "avg_fasting_glucose": float(df["fasting_glucose"].mean()) if len(df) else float("nan"),
    }

    # Figures
    fig_diab = px.histogram(df, x="diabetes_risk", nbins=20, title="Diabetes Risk")
    fig_heart = px.histogram(df, x="heart_disease_risk", nbins=20, title="Heart Disease Risk")
    fig_htn = px.histogram(df, x="hypertension_risk", nbins=20, title="Hypertension Risk")
    fig_scatter = px.scatter(df, x="bmi", y="fasting_glucose", color="diabetes_band", title="BMI vs Fasting Glucose")

    csv_bytes = to_download_bytes(df)
    return metrics, fig_diab, fig_heart, fig_htn, fig_scatter, df.head(50), csv_bytes

# ---------------------------
# Build Gradio UI
# ---------------------------
with gr.Blocks(title="Healthcare Assistant (Demo)") as demo:
    gr.Markdown("## 🩺 Healthcare Assistant — Demo (not medical advice)")
    with gr.Row():
        with gr.Column(scale=3):
            gr.Markdown("### Patient Intake")
            age = gr.Number(value=35, label="Age", interactive=True)
            sex = gr.Dropdown(choices=["Female","Male","Other"], value="Female", label="Sex")
            height_cm = gr.Number(value=170, label="Height (cm)")
            weight_kg = gr.Number(value=70.0, label="Weight (kg)")
            systolic_bp = gr.Number(value=122, label="Systolic BP")
            diastolic_bp = gr.Number(value=80, label="Diastolic BP")
            fasting_glucose = gr.Number(value=95, label="Fasting Glucose (mg/dL)")
            hba1c = gr.Number(value=5.3, label="HbA1c (%)")
            total_chol = gr.Number(value=180, label="Total Cholesterol (mg/dL)")
            hdl = gr.Number(value=50, label="HDL (mg/dL)")
            ldl = gr.Number(value=110, label="LDL (mg/dL)")
            activity_minutes_per_week = gr.Number(value=60, label="Activity (min/week)")
            smoker = gr.Checkbox(label="Currently smokes", value=False)
            family_history = gr.Checkbox(label="Family history of cardiometabolic disease", value=False)
            predict_btn = gr.Button("Predict Risks")

        with gr.Column(scale=4):
            gr.Markdown("### Predictions & Care Plan")
            out_plot = gr.Plot(label="Risk Chart")
            out_table = gr.Dataframe(value=pd.DataFrame(), label="Risk Table")
            out_plan = gr.Textbox(lines=10, label="Autogenerated Care Plan")
            download_report = gr.File(label="Download Report (.txt)")

    # CSV dashboard area
    gr.Markdown("## 📊 Population Dashboard (Upload CSV)")
    csv_uploader = gr.File(label="Upload CSV (patients)", file_count="single", file_types=[".csv"])
    dashboard_btn = gr.Button("Generate Dashboard")
    with gr.Row():
        col1 = gr.Column()
        col2 = gr.Column()
    metrics_text = gr.JSON(value={})
    fig1 = gr.Plot()
    fig2 = gr.Plot()
    fig3 = gr.Plot()
    fig4 = gr.Plot()
    preview_table = gr.Dataframe(value=pd.DataFrame(), label="Data Preview (first 50 rows)")
    download_csv = gr.File(label="Download Enriched CSV")

    # Sample CSV download
    sample_df = pd.DataFrame({
        "patient_id": [f"P{i:03d}" for i in range(1, 31)],
        "age": np.random.randint(25, 75, 30),
        "sex": np.random.choice(["Female","Male","Other"], 30, p=[0.48,0.48,0.04]),
        "height_cm": np.random.normal(168, 10, 30).round(0).clip(145, 195),
        "weight_kg": np.random.normal(75, 15, 30).round(1).clip(45, 140),
        "systolic_bp": np.random.normal(128, 16, 30).round(0).clip(90, 200),
        "diastolic_bp": np.random.normal(82, 10, 30).round(0).clip(55, 120),
        "fasting_glucose": np.random.normal(98, 15, 30).round(0).clip(65, 240),
        "hba1c": np.random.normal(5.6, 0.7, 30).round(1).clip(4.5, 11.0),
        "total_chol": np.random.normal(190, 35, 30).round(0).clip(110, 320),
        "hdl": np.random.normal(52, 12, 30).round(0).clip(25, 90),
        "ldl": np.random.normal(120, 30, 30).round(0).clip(60, 220),
        "smoker": np.random.choice([0,1], 30, p=[0.75,0.25]),
        "family_history": np.random.choice([0,1], 30, p=[0.7,0.3]),
        "activity_minutes_per_week": np.random.normal(110, 70, 30).round(0).clip(0, 600),
    })
    sample_df["bmi"] = sample_df.apply(lambda r: compute_bmi(r["height_cm"], r["weight_kg"]), axis=1)
    sample_csv_bytes = sample_df.to_csv(index=False).encode()
    sample_download = gr.File(label="sample") # Initialize the sample_download component

    # Bind events
    def on_predict_click(
        age_v, sex_v, height_v, weight_v, sys_v, dia_v, fbg_v, a1c_v, chol_v, hdl_v, ldl_v, act_v, smoker_v, fam_v
    ):
        fig, df, plan_text, txt_bytes = predict_single(
            age_v, sex_v, height_v, weight_v, sys_v, dia_v, fbg_v, a1c_v, chol_v, hdl_v, ldl_v, smoker_v, fam_v, act_v
        )
        # prepare downloadable txt file (gradio expects a file-like or path; we return bytes via BytesIO)
        report_io = io.BytesIO(txt_bytes)
        report_io.name = "healthcare_plan_report.txt"
        return fig, df, plan_text, report_io

    predict_btn.click(
        on_predict_click,
        inputs=[age, sex, height_cm, weight_kg, systolic_bp, diastolic_bp, fasting_glucose, hba1c, total_chol, hdl, ldl, activity_minutes_per_week, smoker, family_history],
        outputs=[out_plot, out_table, out_plan, download_report]
    )

    def on_dashboard_click(file_obj):
        if file_obj is None:
            return {"patients":0,"avg_bmi":None,"avg_systolic":None,"avg_fasting_glucose":None}, None, None, None, None, pd.DataFrame(), None
        metrics, f1, f2, f3, f4, head50, csv_bytes = dashboard_from_csv(file_obj.name if hasattr(file_obj, "name") else file_obj)
        csv_io = io.BytesIO(csv_bytes)
        csv_io.name = "patients_enriched.csv"
        return metrics, f1, f2, f3, f4, head50, csv_io

    dashboard_btn.click(
        on_dashboard_click,
        inputs=[csv_uploader],
        outputs=[metrics_text, fig1, fig2, fig3, fig4, preview_table, download_csv]
    )

    # Sample CSV download button (gradio way)
    # we provide a downloadable link by creating a downloadable BytesIO
    def get_sample_file():
        b = io.BytesIO(sample_csv_bytes)
        b.name = "sample_patients.csv"
        return b

    sample_dl_btn = gr.Button("Download Sample CSV")
    sample_dl_btn.click(get_sample_file, inputs=None, outputs=[sample_download]) # Use the component directly

demo.launch(share=True)
